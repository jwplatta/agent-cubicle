FROM node:22-bookworm

RUN apt-get update && apt-get install -y \
    git \
    curl \
    vim \
    build-essential \
    gettext-base \
    && rm -rf /var/lib/apt/lists/*

RUN npm install -g @github/copilot

RUN mkdir -p /workspace

WORKDIR /workspace

# Create non-root user (remove default node user first)
# Using UID 502 and GID 20 to match host macOS user for volume mount permissions
RUN userdel -r node 2>/dev/null || true && \
    groupadd -g 20 copilot 2>/dev/null || groupmod -n copilot $(getent group 20 | cut -d: -f1) && \
    useradd -u 502 -g 20 -m -s /bin/bash copilot && \
    mkdir -p /home/copilot/.copilot /home/copilot/.config/github-copilot /home/copilot/.ssh && \
    chown -R copilot:copilot /home/copilot /workspace

COPY bin/entry-copilot.sh /entry.sh
RUN chmod +x /entry.sh && chown copilot:copilot /entry.sh

USER copilot

CMD ["/entry.sh"]